---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import ArticleMeta from '../../components/ArticleMeta.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import { buildBreadcrumbSchema } from '../../utils/schema';

import integrationsData from '../../../data/integrations.json';
import toolsData from '../../../data/tools.json';
import toolContentData from '../../../data/tool_content.json';
import comparisonsData from '../../../data/comparisons.json';
import alternativesData from '../../../data/alternatives.json';

export function getStaticPaths() {
  return integrationsData.integrations.map((intg: any) => ({
    params: { slug: intg.slug },
    props: { integration: intg }
  }));
}

interface Props {
  integration: any;
}

const { integration } = Astro.props;
const totalJobs = toolsData.total_jobs_analyzed;

const toolA = toolsData.tools.find((t: any) => t.slug === integration.tool_a);
const toolB = toolsData.tools.find((t: any) => t.slug === integration.tool_b);
const contentA = (toolContentData as any)[integration.tool_a];
const contentB = (toolContentData as any)[integration.tool_b];
const nameA = contentA?.display_name || toolA?.name || integration.tool_a;
const nameB = contentB?.display_name || toolB?.name || integration.tool_b;

const lastUpdated = new Date(integration.date_modified || '2026-02-14').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Integrations', href: '/integrations/' },
  { label: `${nameA} + ${nameB}` }
];

const allSchemas: object[] = [
  {
    "@type": "Article",
    "headline": integration.title,
    "description": integration.meta_description,
    "author": { "@type": "Person", "@id": "https://datastackguide.com/about/#rome" },
    "publisher": { "@type": "Organization", "@id": "https://datastackguide.com/#organization", "name": "DataStackGuide" },
    "datePublished": integration.date_published || '2026-02-01',
    "dateModified": integration.date_modified || '2026-02-14'
  },
  buildBreadcrumbSchema(breadcrumbItems)
];

if (integration.setup_considerations?.length > 0) {
  allSchemas.push({
    "@type": "HowTo",
    "name": `How to Set Up ${nameA} + ${nameB} Integration`,
    "step": integration.setup_considerations.map((note: string, i: number) => ({
      "@type": "HowToStep",
      "position": i + 1,
      "text": note
    }))
  });
}

if (integration.faq?.length > 0) {
  allSchemas.push({
    "@type": "FAQPage",
    "mainEntity": integration.faq.map((item: any) => ({
      "@type": "Question",
      "name": item.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.a
      }
    }))
  });
}

// Cross-links: comparisons and alternatives involving these tools
const toolSlugs = new Set([integration.tool_a, integration.tool_b]);

const relatedComparisons = (comparisonsData as any).comparisons
  .filter((c: any) => toolSlugs.has(c.tool_a) || toolSlugs.has(c.tool_b))
  .slice(0, 3);

const relatedAlternatives = alternativesData.alternatives
  .filter((a: any) => toolSlugs.has(a.tool_slug))
  .slice(0, 2);

// Keep title under 42 chars (+ " | DataStackGuide" suffix = 60 max)
const shortIntgTitle = `${nameA} + ${nameB} Integration`;
const minIntgTitle = `${nameA} + ${nameB}`;
const intgTitle = integration.title.length <= 42 ? integration.title : shortIntgTitle.length <= 42 ? shortIntgTitle : minIntgTitle;
---

<BaseLayout
  title={intgTitle}
  description={integration.meta_description}
  ogType="article"
  canonicalPath={`integrations/${integration.slug}/`}
  schemas={allSchemas}
>
  <div class="container-narrow">
    <Breadcrumbs items={breadcrumbItems} noSchema />

    <section class="intg-hero">
      <div class="intg-tools-badge">
        {contentA ? <a href={`/tools/${integration.tool_a}/`}>{nameA}</a> : <span>{nameA}</span>}
        <span class="intg-plus">+</span>
        {contentB ? <a href={`/tools/${integration.tool_b}/`}>{nameB}</a> : <span>{nameB}</span>}
      </div>
      <h1>{integration.title}</h1>
      <ArticleMeta />
      <p class="intg-stat">These tools appear together in <strong>{integration.cooccurrence_count} job postings</strong> in our dataset of {totalJobs.toLocaleString()}+ analyzed positions.</p>
      <p class="intg-overview">{integration.overview}</p>
      <p class="answer-summary">{nameA} and {nameB} appear together in <strong>{integration.cooccurrence_count} job postings</strong>, making this one of the most common integration pairs in the {nameA} ecosystem.</p>
    </section>

    <!-- How They Work Together -->
    <section class="content-section">
      <h2>How They Work Together</h2>
      <div class="workflow-list">
        {integration.how_they_work_together.map((wf: any) => (
          <div class="workflow-item">
            <h3>{wf.workflow}</h3>
            <p>{wf.description}</p>
          </div>
        ))}
      </div>
    </section>

    <!-- Setup Considerations -->
    {integration.setup_considerations?.length > 0 && (
      <section class="content-section">
        <h2>Setup Considerations</h2>
        <div class="setup-list">
          {integration.setup_considerations.map((note: string) => (
            <div class="setup-item">
              <p>{note}</p>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- FAQ -->
    {integration.faq?.length > 0 && (
      <section class="content-section">
        <h2>Frequently Asked Questions</h2>
        <div class="faq-list">
          {integration.faq.map((item: any) => (
            <details class="faq-item">
              <summary>{item.q}</summary>
              <p>{item.a}</p>
            </details>
          ))}
        </div>
      </section>
    )}

    <!-- Related -->
    <section class="content-section related-section">
      <h2>Related</h2>
      <div class="related-grid">
        {contentA && (
          <a href={`/tools/${integration.tool_a}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Tool Review</span>
            <span>{nameA}</span>
          </a>
        )}
        {contentB && (
          <a href={`/tools/${integration.tool_b}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Tool Review</span>
            <span>{nameB}</span>
          </a>
        )}
        {relatedComparisons.map((comp: any) => {
          const cNameA = (toolContentData as any)[comp.tool_a_slug]?.display_name || comp.tool_a_slug;
          const cNameB = (toolContentData as any)[comp.tool_b_slug]?.display_name || comp.tool_b_slug;
          return (
            <a href={`/compare/${comp.slug}/`} class="related-link card">
              <span class="related-link-label text-sm text-muted">Comparison</span>
              <span>{cNameA} vs {cNameB}</span>
            </a>
          );
        })}
        {relatedAlternatives.map((alt: any) => {
          const altName = (toolContentData as any)[alt.tool_slug]?.display_name || alt.tool_slug;
          return (
            <a href={`/alternatives/${alt.slug}/`} class="related-link card">
              <span class="related-link-label text-sm text-muted">Alternatives</span>
              <span>{altName} Alternatives</span>
            </a>
          );
        })}
        <a href="/integrations/" class="related-link card">
          <span class="related-link-label text-sm text-muted">Browse</span>
          <span>All Integrations</span>
        </a>
      </div>
    </section>

    <AuthorBio />

    <div class="page-footer-info">
      <p class="text-sm text-muted">Last updated: {lastUpdated}</p>
      <div class="disclosure">
        <p>DataStackGuide is independently operated. Co-occurrence data from {totalJobs.toLocaleString()}+ real job postings. <a href="/about/">Learn more about us.</a></p>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .intg-hero {
    padding: var(--space-8) 0 var(--space-4);
  }

  .intg-tools-badge {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
    font-weight: 600;
  }

  .intg-tools-badge a {
    color: var(--color-primary);
    text-decoration: none;
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary-subtle);
    border-radius: var(--radius-sm);
  }

  .intg-tools-badge a:hover {
    text-decoration: underline;
  }

  .intg-tools-badge span:not(.intg-plus) {
    padding: var(--space-1) var(--space-3);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
  }

  .intg-plus {
    color: var(--color-text-muted);
    font-size: var(--text-lg);
    font-weight: 400;
    padding: 0 !important;
    background: none !important;
    border: none !important;
  }

  .intg-hero h1 {
    margin-bottom: var(--space-4);
  }

  .intg-stat {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
  }

  .intg-overview {
    color: var(--color-text-secondary);
    line-height: 1.7;
    max-width: 720px;
  }

  .content-section {
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border-subtle);
  }

  .content-section h2 {
    margin-bottom: var(--space-5);
  }

  .content-section p {
    line-height: 1.7;
    margin-bottom: var(--space-4);
    max-width: 720px;
  }

  .content-section p:last-child {
    margin-bottom: 0;
  }

  /* Workflows */
  .workflow-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .workflow-item {
    padding: var(--space-4) var(--space-5);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .workflow-item h3 {
    font-size: var(--text-base);
    margin-bottom: var(--space-2);
    color: var(--color-primary);
  }

  .workflow-item p {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    max-width: none;
  }

  /* Setup */
  .setup-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .setup-item {
    padding-left: var(--space-5);
    border-left: 3px solid var(--color-border);
  }

  .setup-item p {
    margin: 0;
    max-width: none;
  }

  /* FAQ */
  .faq-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .faq-item {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .faq-item summary {
    padding: var(--space-4) var(--space-5);
    font-weight: 600;
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
  }

  .faq-item summary::after {
    content: '+';
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .faq-item[open] summary::after {
    content: '\2212';
  }

  .faq-item summary::-webkit-details-marker {
    display: none;
  }

  .faq-item p {
    padding: 0 var(--space-5) var(--space-5);
    color: var(--color-text-secondary);
    line-height: 1.7;
    max-width: none;
  }

  /* Related */
  .related-section {
    padding-bottom: var(--space-4);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .related-link {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-4) var(--space-5);
    text-decoration: none;
    color: var(--color-text);
  }

  .related-link:hover {
    color: var(--color-primary);
  }

  /* Footer */
  .page-footer-info {
    padding: var(--space-6) 0 var(--space-16);
    border-top: 1px solid var(--color-border-subtle);
  }

  .page-footer-info .disclosure {
    margin-top: var(--space-4);
    padding: 0;
    border: none;
  }
</style>
