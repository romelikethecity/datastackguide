---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import ArticleMeta from '../../components/ArticleMeta.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import { buildBreadcrumbSchema } from '../../utils/schema';

import comparisonsData from '../../../data/comparisons.json';
import toolsData from '../../../data/tools.json';
import toolContentData from '../../../data/tool_content.json';
import alternativesData from '../../../data/alternatives.json';
import guidesData from '../../../data/guides.json';
import useCaseData from '../../../data/use_cases.json';
import integrationsData from '../../../data/integrations.json';
import pricingData from '../../../data/pricing_pages.json';

export function getStaticPaths() {
  return comparisonsData.comparisons.map((comp: any) => ({
    params: { slug: comp.slug },
    props: { comparison: comp }
  }));
}

interface Props {
  comparison: any;
}

const { comparison } = Astro.props;
const totalJobs = toolsData.total_jobs_analyzed;

// Get tool data
const toolA = toolsData.tools.find((t: any) => t.slug === comparison.tool_a);
const toolB = toolsData.tools.find((t: any) => t.slug === comparison.tool_b);
const contentA = (toolContentData as any)[comparison.tool_a];
const contentB = (toolContentData as any)[comparison.tool_b];

const nameA = contentA?.display_name || toolA?.name || comparison.tool_a;
const nameB = contentB?.display_name || toolB?.name || comparison.tool_b;

const lastUpdated = new Date(comparison.date_modified || '2026-02-14').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

// Build all schemas for @graph
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Compare', href: '/compare/' },
  { label: `${nameA} vs ${nameB}` }
];

const allSchemas: object[] = [
  {
    "@type": "Article",
    "headline": comparison.title,
    "description": comparison.meta_description,
    "author": {
      "@type": "Person",
      "@id": "https://datastackguide.com/about/#rome"
    },
    "publisher": {
      "@type": "Organization",
      "@id": "https://datastackguide.com/#organization",
      "name": "DataStackGuide",
      "url": "https://datastackguide.com"
    },
    "datePublished": comparison.date_published || '2026-02-01',
    "dateModified": comparison.date_modified || '2026-02-14'
  },
  buildBreadcrumbSchema(breadcrumbItems)
];

if (comparison.faq?.length > 0) {
  allSchemas.push({
    "@type": "FAQPage",
    "mainEntity": comparison.faq.map((item: any) => ({
      "@type": "Question",
      "name": item.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.a
      }
    }))
  });
}

// Cross-links: alternatives, guides, use cases, integrations for these tools
const toolSlugs = new Set([comparison.tool_a, comparison.tool_b]);
const toolCats = new Set([toolA?.primary_category, toolB?.primary_category].filter(Boolean));

const relatedAlternatives = alternativesData.alternatives
  .filter((a: any) => toolSlugs.has(a.tool_slug))
  .slice(0, 2);

const relatedGuides = guidesData.guides
  .filter((g: any) => g.related_categories?.some((c: string) => toolCats.has(c)))
  .slice(0, 2);

const relatedUseCases = useCaseData.use_cases
  .filter((uc: any) => toolCats.has(uc.category_slug))
  .slice(0, 2);

const relatedIntegration = integrationsData.integrations
  .find((intg: any) =>
    (intg.tool_a === comparison.tool_a && intg.tool_b === comparison.tool_b) ||
    (intg.tool_a === comparison.tool_b && intg.tool_b === comparison.tool_a)
  );

const pricingA = pricingData.pages.find((p: any) => p.tool_slug === comparison.tool_a);
const pricingB = pricingData.pages.find((p: any) => p.tool_slug === comparison.tool_b);

// Keep title under 42 chars (+ " | DataStackGuide" suffix = 60 max)
const shortCompTitle = `${nameA} vs ${nameB} (2026)`;
const minCompTitle = `${nameA} vs ${nameB}`;
const rawCompTitle = comparison.title.length <= 42 ? comparison.title : shortCompTitle.length <= 42 ? shortCompTitle : minCompTitle;
const compTitle = rawCompTitle.length <= 42 ? rawCompTitle : rawCompTitle.slice(0, 39) + '...';
---

<BaseLayout
  title={compTitle}
  description={comparison.meta_description}
  ogType="article"
  canonicalPath={`compare/${comparison.slug}/`}
  schemas={allSchemas}
>

  <div class="container-narrow">
    <Breadcrumbs items={breadcrumbItems} noSchema />

    <!-- Hero -->
    <section class="comp-hero">
      <h1>{comparison.title}</h1>
      <ArticleMeta />
      <p class="comp-hook">{comparison.hook}</p>
      <p class="answer-summary">The key difference between {nameA} and {nameB}: {comparison.short_version}</p>
    </section>

    <!-- Short Version -->
    <section class="short-version">
      <h2 class="sr-only">The Short Version</h2>
      <div class="callout-box">
        <span class="callout-label mono">THE SHORT VERSION</span>
        <p>{comparison.short_version}</p>
      </div>
    </section>

    <!-- Stats Row -->
    {comparison.stats && (
      <section class="stats-section">
        <div class="stats-grid">
          {comparison.stats.map((stat: any) => (
            <div class="stat-card card">
              <span class="stat-label">{stat.label}</span>
              <div class="stat-values">
                <div class="stat-val">
                  <span class="stat-tool-name text-sm">{nameA}</span>
                  <span class="stat-number mono">{stat.tool_a}</span>
                </div>
                <span class="stat-vs text-muted">vs</span>
                <div class="stat-val">
                  <span class="stat-tool-name text-sm">{nameB}</span>
                  <span class="stat-number mono">{stat.tool_b}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Evidence Block -->
    {toolA && toolB && (
      <section class="content-section">
        <p class="data-highlight">In our dataset of <strong>{totalJobs.toLocaleString()}+ job postings</strong>, {nameA} appears in <strong>{toolA.job_count.toLocaleString()} postings</strong> while {nameB} appears in <strong>{toolB.job_count.toLocaleString()}</strong>. {toolA.job_count > toolB.job_count ? `${nameA} has ${Math.round(((toolA.job_count - toolB.job_count) / toolB.job_count) * 100)}% higher adoption in hiring data.` : toolB.job_count > toolA.job_count ? `${nameB} has ${Math.round(((toolB.job_count - toolA.job_count) / toolA.job_count) * 100)}% higher adoption in hiring data.` : 'Both tools show equal adoption.'}</p>
      </section>
    )}

    <!-- Quick Comparison Table -->
    <section class="content-section">
      <h2>Quick Comparison</h2>
      <div class="table-wrap">
        <table class="comp-table">
          <thead>
            <tr>
              <th>Feature</th>
              <th>{nameA}</th>
              <th>{nameB}</th>
            </tr>
          </thead>
          <tbody>
            {comparison.comparison_rows.map((row: any) => (
              <tr>
                <td class="feature-col">{row.feature}</td>
                <td>{row.tool_a}</td>
                <td>{row.tool_b}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Deep Dive: Tool A -->
    <section class="content-section">
      <h2>Deep Dive: {nameA}</h2>

      <h3>What They're Selling</h3>
      <p>{comparison.deep_dive_a.selling_pitch}</p>

      <h3>What It Actually Costs</h3>
      <p>{comparison.deep_dive_a.real_cost}</p>

      <h3>What Users Say</h3>
      <p>{comparison.deep_dive_a.user_sentiment}</p>

      <div class="proscons-inline">
        <div class="pros-col">
          <h4>Pros</h4>
          <ul>
            {comparison.deep_dive_a.pros.map((pro: string) => (
              <li class="pro-item">{pro}</li>
            ))}
          </ul>
        </div>
        <div class="cons-col">
          <h4>Cons</h4>
          <ul>
            {comparison.deep_dive_a.cons.map((con: string) => (
              <li class="con-item">{con}</li>
            ))}
          </ul>
        </div>
      </div>

      {contentA && (
        <p><a href={`/tools/${comparison.tool_a}/`}>Read the full {nameA} review →</a></p>
      )}
    </section>

    <!-- Deep Dive: Tool B -->
    <section class="content-section">
      <h2>Deep Dive: {nameB}</h2>

      <h3>What They're Selling</h3>
      <p>{comparison.deep_dive_b.selling_pitch}</p>

      <h3>What It Actually Costs</h3>
      <p>{comparison.deep_dive_b.real_cost}</p>

      <h3>What Users Say</h3>
      <p>{comparison.deep_dive_b.user_sentiment}</p>

      <div class="proscons-inline">
        <div class="pros-col">
          <h4>Pros</h4>
          <ul>
            {comparison.deep_dive_b.pros.map((pro: string) => (
              <li class="pro-item">{pro}</li>
            ))}
          </ul>
        </div>
        <div class="cons-col">
          <h4>Cons</h4>
          <ul>
            {comparison.deep_dive_b.cons.map((con: string) => (
              <li class="con-item">{con}</li>
            ))}
          </ul>
        </div>
      </div>

      {contentB && (
        <p><a href={`/tools/${comparison.tool_b}/`}>Read the full {nameB} review →</a></p>
      )}
    </section>

    <!-- Which Should You Pick? -->
    {comparison.which_to_pick && (
      <section class="content-section">
        <h2>Which Should You Pick?</h2>
        <div class="scenarios">
          {comparison.which_to_pick.map((item: any) => (
            <div class="scenario-row">
              <div class="scenario-if">
                <span class="scenario-label mono text-sm">IF</span>
                <span>{item.scenario}</span>
              </div>
              <div class="scenario-then">
                <span class="scenario-label mono text-sm">THEN</span>
                <span>{item.recommendation}</span>
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- The Honest Take -->
    <section class="content-section">
      <h2>The Honest Take</h2>
      <div class="honest-box">
        <p>{comparison.honest_take}</p>
      </div>
    </section>

    <!-- Questions Before Buying -->
    {comparison.questions_before_buying && (
      <section class="content-section">
        <h2>Questions to Ask Before Buying</h2>
        <ol class="questions-list">
          {comparison.questions_before_buying.map((q: string) => (
            <li>{q}</li>
          ))}
        </ol>
      </section>
    )}

    <!-- FAQ -->
    {comparison.faq?.length > 0 && (
      <section class="content-section">
        <h2>Frequently Asked Questions</h2>
        <div class="faq-list">
          {comparison.faq.map((item: any) => (
            <details class="faq-item">
              <summary>{item.q}</summary>
              <p>{item.a}</p>
            </details>
          ))}
        </div>
      </section>
    )}

    <!-- Related Links -->
    <section class="content-section related-section">
      <h2>Related</h2>
      <div class="related-grid">
        {contentA && (
          <a href={`/tools/${comparison.tool_a}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Tool Review</span>
            <span>{nameA}</span>
          </a>
        )}
        {contentB && (
          <a href={`/tools/${comparison.tool_b}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Tool Review</span>
            <span>{nameB}</span>
          </a>
        )}
        {pricingA && (
          <a href={`/pricing/${pricingA.slug}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Pricing</span>
            <span>{nameA} Pricing</span>
          </a>
        )}
        {pricingB && (
          <a href={`/pricing/${pricingB.slug}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Pricing</span>
            <span>{nameB} Pricing</span>
          </a>
        )}
        {relatedAlternatives.map((alt: any) => {
          const altToolName = (toolContentData as any)[alt.tool_slug]?.display_name || alt.tool_slug;
          return (
            <a href={`/alternatives/${alt.slug}/`} class="related-link card">
              <span class="related-link-label text-sm text-muted">Alternatives</span>
              <span>{altToolName} Alternatives</span>
            </a>
          );
        })}
        {relatedIntegration && (
          <a href={`/integrations/${relatedIntegration.slug}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Integration</span>
            <span>{nameA} + {nameB}</span>
          </a>
        )}
        {relatedUseCases.map((uc: any) => (
          <a href={`/use-cases/${uc.slug}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Use Case</span>
            <span>{uc.title}</span>
          </a>
        ))}
        {relatedGuides.map((g: any) => (
          <a href={`/guides/${g.slug}/`} class="related-link card">
            <span class="related-link-label text-sm text-muted">Guide</span>
            <span>{g.title}</span>
          </a>
        ))}
        <a href="/compare/" class="related-link card">
          <span class="related-link-label text-sm text-muted">Browse</span>
          <span>All Comparisons</span>
        </a>
      </div>
    </section>

    <AuthorBio />

    <!-- Footer -->
    <div class="page-footer-info">
      <p class="text-sm text-muted">Last updated: {lastUpdated}</p>
      <div class="disclosure">
        <p>DataStackGuide is independently operated. Some links on this page may be affiliate links. Our job market data comes from analyzing {totalJobs.toLocaleString()}+ real job postings. <a href="/about/">Learn more about our methodology.</a></p>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .comp-hero {
    padding: var(--space-8) 0 var(--space-4);
  }

  .comp-hero h1 {
    margin-bottom: var(--space-4);
  }

  .comp-hook {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: 1.5;
  }

  /* Short Version Callout */
  .short-version {
    padding: var(--space-4) 0;
  }

  .callout-box {
    background: var(--color-primary-subtle);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
  }

  .callout-label {
    display: inline-block;
    font-size: var(--text-xs);
    color: var(--color-primary);
    font-weight: 700;
    letter-spacing: 0.1em;
    margin-bottom: var(--space-3);
  }

  .callout-box p {
    line-height: 1.7;
    margin: 0;
  }

  /* Stats */
  .stats-section {
    padding: var(--space-4) 0;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: var(--space-4);
  }

  .stat-card {
    text-align: center;
    padding: var(--space-4);
  }

  .stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 500;
    display: block;
    margin-bottom: var(--space-3);
  }

  .stat-values {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
  }

  .stat-val {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .stat-tool-name {
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .stat-number {
    font-weight: 700;
    font-size: var(--text-base);
  }

  .stat-vs {
    font-size: var(--text-xs);
    font-weight: 600;
  }

  /* Content Sections */
  .content-section {
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border-subtle);
  }

  .content-section h2 {
    margin-bottom: var(--space-5);
  }

  .content-section h3 {
    margin-top: var(--space-5);
    margin-bottom: var(--space-3);
    font-size: var(--text-base);
    font-weight: 700;
  }

  .content-section h3:first-of-type {
    margin-top: 0;
  }

  .content-section p {
    line-height: 1.7;
    margin-bottom: var(--space-4);
  }

  .content-section p:last-child {
    margin-bottom: 0;
  }

  /* Comparison Table */
  .table-wrap {
    overflow-x: auto;
    margin-top: var(--space-3);
  }

  .comp-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
  }

  .comp-table th {
    text-align: left;
    padding: var(--space-3) var(--space-4);
    border-bottom: 2px solid var(--color-border);
    font-weight: 600;
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    white-space: nowrap;
  }

  .comp-table td {
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--color-border-subtle);
    vertical-align: top;
  }

  .comp-table .feature-col {
    font-weight: 600;
    white-space: nowrap;
  }

  .comp-table tr:hover td {
    background: var(--color-primary-subtle);
  }

  /* Pros/Cons Inline */
  .proscons-inline {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-5);
    margin: var(--space-5) 0;
  }

  .proscons-inline h4 {
    font-size: var(--text-sm);
    font-weight: 700;
    margin-bottom: var(--space-3);
  }

  .proscons-inline ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .proscons-inline .pro-item::before {
    content: '✓ ';
    color: #10B981;
    font-weight: 700;
  }

  .proscons-inline .con-item::before {
    content: '✗ ';
    color: #EF4444;
    font-weight: 700;
  }

  /* Scenarios */
  .scenarios {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .scenario-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .scenario-if,
  .scenario-then {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .scenario-label {
    color: var(--color-primary);
    font-weight: 700;
    letter-spacing: 0.1em;
  }

  /* Honest Take */
  .honest-box {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--space-5);
  }

  .honest-box p {
    line-height: 1.8;
  }

  /* Questions */
  .questions-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding-left: var(--space-6);
  }

  .questions-list li {
    line-height: 1.6;
  }

  /* FAQ */
  .faq-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .faq-item {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .faq-item summary {
    padding: var(--space-4) var(--space-5);
    font-weight: 600;
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
  }

  .faq-item summary::after {
    content: '+';
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .faq-item[open] summary::after {
    content: '−';
  }

  .faq-item summary::-webkit-details-marker {
    display: none;
  }

  .faq-item p {
    padding: 0 var(--space-5) var(--space-5);
    color: var(--color-text-secondary);
    line-height: 1.7;
  }

  /* Related */
  .related-section {
    padding-bottom: var(--space-4);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .related-link {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-4) var(--space-5);
    text-decoration: none;
    color: var(--color-text);
  }

  .related-link:hover {
    color: var(--color-primary);
  }

  /* Footer */
  .page-footer-info {
    padding: var(--space-6) 0 var(--space-16);
    border-top: 1px solid var(--color-border-subtle);
  }

  .page-footer-info .disclosure {
    margin-top: var(--space-4);
    padding: 0;
    border: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr 1fr;
    }

    .proscons-inline {
      grid-template-columns: 1fr;
    }

    .scenario-row {
      grid-template-columns: 1fr;
    }
  }
</style>
