---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import ArticleMeta from '../../components/ArticleMeta.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import { buildBreadcrumbSchema } from '../../utils/schema';

import useCaseData from '../../../data/use_cases.json';
import toolsData from '../../../data/tools.json';
import toolContentData from '../../../data/tool_content.json';
import categoriesData from '../../../data/categories.json';
import comparisonsData from '../../../data/comparisons.json';

export function getStaticPaths() {
  return useCaseData.use_cases.map((uc: any) => ({
    params: { slug: uc.slug },
    props: { useCase: uc }
  }));
}

interface Props {
  useCase: any;
}

const { useCase } = Astro.props;
const totalJobs = toolsData.total_jobs_analyzed;

const category = categoriesData.categories.find((c: any) => c.slug === useCase.category_slug);
const categoryName = category?.name || useCase.category_slug;
const categoryColor = category?.color || '#14B8A6';

// Build recommended tools with data from tools.json
const recommendedTools = useCase.recommended_tools.map((rec: any) => {
  const tool = toolsData.tools.find((t: any) => t.slug === rec.slug);
  const content = (toolContentData as any)[rec.slug];
  return {
    ...rec,
    name: content?.display_name || tool?.name || rec.slug,
    hasPage: !!content,
    job_count: tool?.job_count || 0,
    salary_min: tool?.salary_min,
    salary_max: tool?.salary_max
  };
});

// Cross-links: comparisons between recommended tools
const recToolSlugs = new Set(useCase.recommended_tools.map((rt: any) => rt.slug));
const relatedComparisons = (comparisonsData as any).comparisons
  .filter((c: any) => recToolSlugs.has(c.tool_a) || recToolSlugs.has(c.tool_b))
  .slice(0, 3);

const lastUpdated = new Date(useCase.date_modified || '2026-02-14').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Use Cases', href: '/use-cases/' },
  { label: useCase.title }
];

const allSchemas: object[] = [
  {
    "@type": "Article",
    "headline": useCase.title,
    "description": useCase.meta_description,
    "author": { "@type": "Person", "@id": "https://datastackguide.com/about/#rome" },
    "publisher": { "@type": "Organization", "@id": "https://datastackguide.com/#organization", "name": "DataStackGuide" },
    "datePublished": useCase.date_published || '2026-02-01',
    "dateModified": useCase.date_modified || '2026-02-14'
  },
  buildBreadcrumbSchema(breadcrumbItems)
];

if (useCase.faq?.length > 0) {
  allSchemas.push({
    "@type": "FAQPage",
    "mainEntity": useCase.faq.map((item: any) => ({
      "@type": "Question",
      "name": item.q,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": item.a
      }
    }))
  });
}

// Keep title under 42 chars (+ " | DataStackGuide" suffix = 60 max)
const shortUcTitle = useCase.title.replace(/ \(\d{4}\)$/, '');
const ucTitle = useCase.title.length <= 42 ? useCase.title : shortUcTitle.length <= 42 ? shortUcTitle : shortUcTitle.slice(0, 39) + '...';
---

<BaseLayout
  title={ucTitle}
  description={useCase.meta_description}
  ogType="article"
  canonicalPath={`use-cases/${useCase.slug}/`}
  schemas={allSchemas}
>
  <div class="container-narrow">
    <Breadcrumbs items={breadcrumbItems} noSchema />

    <section class="uc-hero">
      <a href={`/categories/${useCase.category_slug}/`} class="uc-category-badge" style={`background: ${categoryColor}15; color: ${categoryColor};`}>
        {categoryName}
      </a>
      <h1>{useCase.title}</h1>
      <ArticleMeta />
      <p class="uc-persona"><strong>For:</strong> {useCase.persona}</p>
      <p class="uc-intro">{useCase.intro}</p>
      {recommendedTools?.[0] && (
        <p class="answer-summary">Our top pick for {useCase.persona.toLowerCase()} is <strong>{recommendedTools[0].name}</strong>{recommendedTools[0].job_count > 0 ? `, mentioned in ${recommendedTools[0].job_count.toLocaleString()} job postings` : ''}.</p>
      )}
    </section>

    <!-- What to Look For -->
    <section class="content-section">
      <h2>What to Look For</h2>
      <div class="criteria-list">
        {useCase.what_to_look_for.map((item: any) => (
          <div class="criteria-item">
            <h3>{item.criteria}</h3>
            <p>{item.why}</p>
          </div>
        ))}
      </div>
    </section>

    <!-- Recommended Tools -->
    <section class="content-section">
      <h2>Our Recommendations</h2>
      {recommendedTools.map((tool: any, i: number) => (
        <div class="rec-tool">
          <div class="rec-tool-header">
            <h3>
              {i + 1}.{' '}
              {tool.hasPage ? (
                <a href={`/tools/${tool.slug}/`}>{tool.name}</a>
              ) : (
                <span>{tool.name}</span>
              )}
            </h3>
            {tool.job_count > 0 && (
              <span class="rec-tool-jobs mono text-sm text-muted">{tool.job_count.toLocaleString()} job mentions</span>
            )}
          </div>
          <p>{tool.why}</p>
        </div>
      ))}
    </section>

    <!-- Bottom Line -->
    <section class="content-section">
      <h2>The Bottom Line</h2>
      <div class="bottom-line-box">
        <p>{useCase.bottom_line}</p>
      </div>
    </section>

    <!-- FAQ -->
    {useCase.faq?.length > 0 && (
      <section class="content-section">
        <h2>Frequently Asked Questions</h2>
        <div class="faq-list">
          {useCase.faq.map((item: any) => (
            <details class="faq-item">
              <summary>{item.q}</summary>
              <p>{item.a}</p>
            </details>
          ))}
        </div>
      </section>
    )}

    <!-- Related -->
    <section class="content-section related-section">
      <h2>Related</h2>
      <div class="related-grid">
        <a href={`/categories/${useCase.category_slug}/`} class="related-link card">
          <span class="related-link-label text-sm text-muted">Category</span>
          <span>{categoryName} Tools</span>
        </a>
        {relatedComparisons.map((comp: any) => {
          const cNameA = (toolContentData as any)[comp.tool_a]?.display_name || comp.tool_a;
          const cNameB = (toolContentData as any)[comp.tool_b]?.display_name || comp.tool_b;
          return (
            <a href={`/compare/${comp.slug}/`} class="related-link card">
              <span class="related-link-label text-sm text-muted">Comparison</span>
              <span>{cNameA} vs {cNameB}</span>
            </a>
          );
        })}
        <a href="/use-cases/" class="related-link card">
          <span class="related-link-label text-sm text-muted">Browse</span>
          <span>All Use Cases</span>
        </a>
      </div>
    </section>

    <AuthorBio />

    <div class="page-footer-info">
      <p class="text-sm text-muted">Last updated: {lastUpdated}</p>
      <div class="disclosure">
        <p>DataStackGuide is independently operated. Some links may be affiliate links. Our data comes from analyzing {totalJobs.toLocaleString()}+ real job postings. <a href="/about/">Learn more about us.</a></p>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .uc-hero {
    padding: var(--space-8) 0 var(--space-4);
  }

  .uc-category-badge {
    display: inline-block;
    font-size: var(--text-xs);
    font-weight: 500;
    padding: 2px 10px;
    border-radius: var(--radius-full);
    text-decoration: none;
    margin-bottom: var(--space-4);
  }

  .uc-hero h1 {
    margin-bottom: var(--space-4);
  }

  .uc-persona {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
  }

  .uc-intro {
    color: var(--color-text-secondary);
    line-height: 1.7;
    font-size: var(--text-base);
    max-width: 720px;
  }

  .content-section {
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border-subtle);
  }

  .content-section h2 {
    margin-bottom: var(--space-5);
  }

  .content-section p {
    line-height: 1.7;
    margin-bottom: var(--space-4);
    max-width: 720px;
  }

  .content-section p:last-child {
    margin-bottom: 0;
  }

  /* Criteria */
  .criteria-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .criteria-item {
    padding: var(--space-4) var(--space-5);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .criteria-item h3 {
    font-size: var(--text-base);
    margin-bottom: var(--space-2);
    color: var(--color-primary);
  }

  .criteria-item p {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    max-width: none;
  }

  /* Recommended Tools */
  .rec-tool {
    padding: var(--space-5) 0;
    border-bottom: 1px solid var(--color-border-subtle);
  }

  .rec-tool:last-child {
    border-bottom: none;
  }

  .rec-tool-header {
    display: flex;
    align-items: baseline;
    gap: var(--space-4);
    flex-wrap: wrap;
    margin-bottom: var(--space-2);
  }

  .rec-tool-header h3 {
    font-size: var(--text-lg);
    margin: 0;
  }

  .rec-tool-header h3 a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .rec-tool-header h3 a:hover {
    text-decoration: underline;
  }

  .rec-tool p {
    max-width: 720px;
  }

  /* Bottom Line */
  .bottom-line-box {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--space-5);
  }

  .bottom-line-box p {
    line-height: 1.8;
    max-width: none;
  }

  /* FAQ */
  .faq-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .faq-item {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .faq-item summary {
    padding: var(--space-4) var(--space-5);
    font-weight: 600;
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
  }

  .faq-item summary::after {
    content: '+';
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .faq-item[open] summary::after {
    content: '\2212';
  }

  .faq-item summary::-webkit-details-marker {
    display: none;
  }

  .faq-item p {
    padding: 0 var(--space-5) var(--space-5);
    color: var(--color-text-secondary);
    line-height: 1.7;
    max-width: none;
  }

  /* Related */
  .related-section {
    padding-bottom: var(--space-4);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .related-link {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-4) var(--space-5);
    text-decoration: none;
    color: var(--color-text);
  }

  .related-link:hover {
    color: var(--color-primary);
  }

  /* Footer */
  .page-footer-info {
    padding: var(--space-6) 0 var(--space-16);
    border-top: 1px solid var(--color-border-subtle);
  }

  .page-footer-info .disclosure {
    margin-top: var(--space-4);
    padding: 0;
    border: none;
  }
</style>
